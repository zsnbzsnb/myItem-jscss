<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>订单详情 - 待支付</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .order-item:hover {
          transform: translateY(-2px);
          transition: all 0.2s ease;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- 新增返回按钮容器 -->
      <div class="mb-6">
        <button
          onclick="window.history.back()"
          class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
        >
          <i class="fas fa-arrow-left mr-2"></i>
          返回
        </button>
      </div>

      <!-- 原订单头部信息 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-2xl font-bold text-gray-800">订单详情</h1>
          <span
            class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium"
          >
            待支付
          </span>
        </div>
        <div class="space-y-2">
          <div class="flex items-center">
            <i class="fas fa-receipt text-gray-500 mr-2"> </i>
            <span class="text-gray-600"> 订单编号： </span>
            <span class="font-medium" data-order-number>ORD20231115-123456</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-clock text-gray-500 mr-2"> </i>
            <span class="text-gray-600"> 创建时间： </span>
            <span class="font-medium" data-order-time>2023-11-15 14:30:25</span>
          </div>
        </div>
        <!-- 修改收件人信息部分 -->
        <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
          <div class="flex items-start">
            <i class="fas fa-user text-gray-500 mr-2 mt-1"> </i>
            <div>
              <span class="text-gray-600"> 收件人： </span>
              <span class="font-medium" data-receiver>张三</span>
            </div>
          </div>
          <div class="flex items-start">
            <i class="fas fa-phone text-gray-500 mr-2 mt-1"> </i>
            <div>
              <span class="text-gray-600"> 手机号： </span>
              <span class="font-medium" data-phone>13800138000</span>
            </div>
          </div>
          <div class="flex items-start">
            <i class="fas fa-map-marker-alt text-gray-500 mr-2 mt-1"> </i>
            <div>
              <span class="text-gray-600"> 收货地址： </span>
              <span class="font-medium" data-address>北京市朝阳区...</span>
            </div>
          </div>
        </div>
      </div>
      <!-- 商品列表 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">商品信息</h2>
        <div class="space-y-4">
          <!-- 商品项1 -->
          <div
            class="order-item flex border-b pb-4 last:border-b-0 hover:shadow-sm"
          >
            <div class="w-24 h-24 rounded-md overflow-hidden mr-4">
              <img
                src="https://aidev.gemcoder.com/staticResource/echoAiSystemImages/44a64c8193bc4ec5362432b60b7ce7f1.png"
                alt="智能手机"
                class="w-full h-full object-cover"
              />
            </div>
            <div class="flex-1">
              <h3 class="font-medium text-gray-800">
                高端智能手机 Pro Max 256GB
              </h3>
              <p class="text-sm text-gray-500 mt-1">颜色: 星空黑</p>
              <div class="flex justify-between items-center mt-2">
                <span class="text-gray-600"> x1 </span>
                <span class="font-medium text-red-500"> ¥8999.00 </span>
              </div>
            </div>
          </div>
          <!-- 商品项2 -->
          <div
            class="order-item flex border-b pb-4 last:border-b-0 hover:shadow-sm"
          >
            <div class="w-24 h-24 rounded-md overflow-hidden mr-4">
              <img
                src="https://aidev.gemcoder.com/staticResource/echoAiSystemImages/7c43795fa894bc6397d1ba5b5418b2d7.png"
                alt="无线耳机"
                class="w-full h-full object-cover"
              />
            </div>
            <div class="flex-1">
              <h3 class="font-medium text-gray-800">真无线蓝牙耳机 Pro</h3>
              <p class="text-sm text-gray-500 mt-1">颜色: 白色</p>
              <div class="flex justify-between items-center mt-2">
                <span class="text-gray-600"> x1 </span>
                <span class="font-medium text-red-500"> ¥599.00 </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 订单金额 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">订单金额</h2>
        <div class="space-y-2">
          <!-- 订单金额部分 -->
          <!-- 商品项1 (删除静态图片和商品信息) -->
          <div class="order-item flex border-b pb-4 last:border-b-0 hover:shadow-sm">
            <div class="w-24 h-24 rounded-md overflow-hidden mr-4">
              <!-- 图片将由JS动态生成 -->
            </div>
            <div class="flex-1">
              <!-- 商品信息将由JS动态生成 -->
            </div>
          </div>
          
          <!-- 订单金额 (删除静态金额数据) -->
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600"> 商品总价 </span>
              <span data-total><!-- 动态数据 --></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600"> 运费 </span>
              <span data-shipping><!-- 动态数据 --></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600"> 优惠券 </span>
              <span data-coupon><!-- 动态数据 --></span>
            </div>
            <div class="border-t border-gray-200 my-3"></div>
            <div class="flex justify-between text-lg font-bold">
              <span class="text-gray-800"> 实付金额 </span>
              <span class="text-red-500" data-final><!-- 动态数据 --></span>
            </div>
          </div>
        </div>
      </div>
      <!-- 支付方式 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">支付方式</h2>
        <div class="space-y-3">
          <label
            class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-blue-500"
          >
            <input
              type="radio"
              name="payment"
              value="2" 
              checked
              class="h-4 w-4 text-blue-600 focus:ring-blue-500"
            />
            <div class="ml-3 flex items-center">
              <i class="fab fa-alipay text-2xl text-blue-500 mr-2"> </i>
              <span> 支付宝支付 </span>
            </div>
          </label>
          <label
            class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-green-500"
          >
            <input
              type="radio"
              name="payment"
              value="1"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500"
            />
            <div class="ml-3 flex items-center">
              <i class="fab fa-weixin text-2xl text-green-500 mr-2"> </i>
              <span> 微信支付 </span>
            </div>
          </label>
        </div>
      </div>
      <!-- 操作按钮 -->
      <div class="flex justify-end mt-6">
        <button
          id="payBtn"
          class="px-6 py-3 bg-blue-600 rounded-lg text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          <i class="fas fa-credit-card mr-2"></i>
          立即支付
        </button>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const productIds = urlParams.get('productIds') || '';
    
        // 新增：检查JWT令牌
        const jwtToken = localStorage.getItem('jwtToken');
        if (!jwtToken) {
          window.location.href = 'login.html';
          return;
        }
    
        if (userId && productIds) {
          Promise.all([
            fetch(`http://localhost:9527/goods/getProductsByPhotoIds?${productIds.split(',').map(id => `productIds=${id}`).join('&')}`, {
              headers: { 'Authorization': `Bearer ${jwtToken}` }
            }),
            fetch(`http://localhost:9527/address/getStatusAddressByUserId?userId=${userId}`, {
              headers: { 'Authorization': `Bearer ${jwtToken}` }
            })
          ])
          .then(async ([goodsRes, addressRes]) => {
            try {
              // 统一处理响应状态
              if (!goodsRes.ok || !addressRes.ok) throw new Error('接口响应异常');
    
              const [goodsData, addressData] = await Promise.all([
                goodsRes.json(),
                addressRes.json()
              ]);
    
              // +++ 新增订单创建逻辑 +++
              try {
                if (goodsData.code === "200") {
                  const productImageIds = goodsData.data.map(p => 
                    p.photos?.split(',')[0]?.trim() || ''
                  );
                  
                  // 获取支付方式
                  const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

                  // 计算总金额
                  const totalAmount = goodsData.data.reduce((sum, p) => sum + p.price, 0);

                  const createOrderRes = await fetch('http://localhost:9527/order/insertOrder', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${jwtToken}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      productIds: productIds,
                      productImageIds: productImageIds.join(','),
                      paymentMethod: paymentMethod,
                      totalAmount: totalAmount,
                      actualAmount: totalAmount  // 新增实际金额字段
                    })
                  });
                  
                  if (!createOrderRes.ok) throw new Error(`HTTP错误 ${createOrderRes.status}`);
                  const createResult = await createOrderRes.json();
                  if (createResult.code === "200") {
                    const orderId = createResult.data;
                    
                    // 添加支付方式变更监听
                    document.querySelectorAll('input[name="payment"]').forEach(radio => {
                        radio.addEventListener('change', async (e) => {
                            try {
                                const updateRes = await fetch(`http://localhost:9527/order/updatePayMethod?orderId=${orderId}&paymentMethod=${e.target.value}`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${jwtToken}`
                                    }
                                });
                                
                                if (!updateRes.ok) throw new Error(`HTTP错误 ${updateRes.status}`);
                                const updateResult = await updateRes.json();
                                
                                if (updateResult.code === "200") {
                                    console.log('支付方式更新成功');
                                    // 重新获取订单数据
                                    const refreshRes = await fetch(`http://localhost:9527/order/getOrderByOrderId?orderId=${orderId}`, {
                                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                                    });
                                    if (refreshRes.ok) {
                                        const refreshedOrder = await refreshRes.json();
                                        // 更新前端支付方式显示
                                        document.querySelector(`input[value="${refreshedOrder.data.paymentMethod}"]`).checked = true;
                                    }
                                } else {
                                    console.error('支付方式更新失败:', updateResult.message);
                                    radio.checked = !radio.checked; // 回滚选择状态
                                }
                            } catch (error) {
                                console.error('支付方式更新异常:', error);
                                radio.checked = !radio.checked; // 回滚选择状态
                            }
                        });
                    });

                    // 获取订单详细信息（原有代码）
                    const orderDetailRes = await fetch(`http://localhost:9527/order/getOrderByOrderId?orderId=${orderId}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (orderDetailRes.ok) {
                      const orderDetail = await orderDetailRes.json();
                      console.log('订单详细信息:', orderDetail);
                      
                      // 新增订单信息渲染
                      document.querySelector('[data-order-number]').textContent = orderDetail.data.orderNumber;
                      const orderDate = new Date(orderDetail.data.orderTime);
                      document.querySelector('[data-order-time]').textContent = 
                        `${orderDate.getFullYear()}-${(orderDate.getMonth() + 1).toString().padStart(2, '0')}-${orderDate.getDate().toString().padStart(2, '0')} ${orderDate.getHours().toString().padStart(2, '0')}:${orderDate.getMinutes().toString().padStart(2, '0')}:${orderDate.getSeconds().toString().padStart(2, '0')}`;
                    }
                  } else {
                    console.error('订单创建失败:', createResult.message);
                  }
                }
              } catch (orderError) {
                console.error('订单创建异常:', orderError);
              }
              // --- 新增逻辑结束 ---
    
              // 保留原有商品数据渲染逻辑
              if (goodsData.code === "200") {
                const goodsContainer = document.querySelector('.space-y-4');
                goodsContainer.innerHTML = goodsData.data.map(product => `
                  <div class="order-item flex border-b pb-4 last:border-b-0 hover:shadow-sm">
                    <div class="w-24 h-24 rounded-md overflow-hidden mr-4">
                      <img src="${product.photos?.split(',')[0] || ''}" 
                           alt="${product.productName}"
                           class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                      <h3 class="font-medium text-gray-800">${product.productName}</h3>
                      ${product.description ? `<p class="text-sm text-gray-500 mt-1">${product.description}</p>` : ''}
                      <div class="flex justify-between items-center mt-2">
                        <span class="text-gray-600">x1</span>
                        <span class="font-medium text-red-500">¥${product.price.toFixed(2)}</span>
                      </div>
                    </div>
                  </div>
                `).join('');
    
                // 更新订单金额
                const totalAmount = goodsData.data.reduce((sum, p) => sum + p.price, 0);
                document.querySelectorAll('[data-total]').forEach(el => el.textContent = `¥${totalAmount.toFixed(2)}`);
                document.querySelector('[data-final]').textContent = `¥${totalAmount.toFixed(2)}`;
              }
    
              // 地址数据渲染
              if (addressData.code === "200") {
                const addr = addressData.data;
                const fullAddress = [addr.province, addr.city, addr.district, addr.detailAddress].filter(Boolean).join('');
                document.querySelector('[data-address]').textContent = fullAddress;
                document.querySelector('[data-phone]').textContent = addr.receiverPhone;
                document.querySelector('[data-receiver]').textContent = addr.receiverName;
              }
            } catch (error) {
              console.error('数据处理失败:', error);
              alert('数据解析异常');
            }
          })
          .catch(error => {
            console.error('请求失败:', error);
            alert('请求失败: ' + error.message);
          });
        } else {
          console.error('缺失参数:', { userId, productIds });
          alert('订单参数不完整');
          window.location.href = 'myCart.html';
        }
    
        // 移除原有的本地存储逻辑（localStorage.setItem相关代码）
        // ...保留支付按钮和倒计时逻辑...
      });
    </script>
    

</script>
  </body>
</html>
